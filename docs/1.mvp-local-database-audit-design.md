# MVP: Sistema Local de AuditorÃ­a de Seguridad de Base de Datos

**VersiÃ³n:** 1.0
**Fecha:** 2025-11-04
**Autor:** Equipo de Desarrollo
**Estado:** DiseÃ±o TÃ©cnico Completo

---

## 1. Resumen Ejecutivo

### 1.1 Objetivo

Crear sistema MVP para auditar seguridad de esquemas PostgreSQL/Supabase de forma local, generando reportes enriquecidos con anÃ¡lisis de IA (Claude) que incluyan:
- Contexto de negocio
- PriorizaciÃ³n de hallazgos
- Pasos de remediaciÃ³n especÃ­ficos

### 1.2 Alcance MVP vs Futuro

| CaracterÃ­stica | MVP Local (Fase 1) | CI/CD Automatizado (Fase 2) |
|----------------|--------------------|-----------------------------|
| EjecuciÃ³n | Manual (`npm run audit:db`) | AutomÃ¡tica en cada PR |
| Entorno | Docker local | GitHub Actions |
| Input | `sql/full_schema.sql` | Schema en PR |
| Output | `audit-report.md` local | Comentario en PR |
| AnÃ¡lisis IA | âœ… Claude API | âœ… Claude API (reutilizado) |
| Queries seguridad | âœ… 14 queries | âœ… Mismas 14 queries |
| ReutilizaciÃ³n cÃ³digo | N/A | **95%+ reutilizable** |

### 1.3 Valor del MVP

1. **ValidaciÃ³n rÃ¡pida**: Boss puede revisar reportes antes de automatizar
2. **IteraciÃ³n local**: Ajustar schema y re-auditar inmediatamente
3. **ReducciÃ³n riesgo**: Probar sistema completo antes de CI/CD
4. **Base sÃ³lida**: Core tÃ©cnico 95%+ reutilizable en Fase 2

---

## 2. Arquitectura del Sistema

### 2.1 Diagrama de Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLI Entry Point                          â”‚
â”‚                  src/audit/cli.ts                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Docker Manager                               â”‚
â”‚           src/audit/docker-manager.ts                       â”‚
â”‚  â€¢ Crear contenedor PostgreSQL 15 efÃ­mero                   â”‚
â”‚  â€¢ Cargar sql/full_schema.sql                               â”‚
â”‚  â€¢ Destruir contenedor al finalizar                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 DB Auditor                                  â”‚
â”‚            src/audit/db-auditor.ts                          â”‚
â”‚  â€¢ Ejecutar mini_suite_v2.sql (14 queries)                  â”‚
â”‚  â€¢ Recolectar hallazgos raw                                 â”‚
â”‚  â€¢ Estructurar resultados                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 AI Analyzer                                 â”‚
â”‚           src/audit/ai-analyzer.ts                          â”‚
â”‚  â€¢ Enviar hallazgos a Claude API                            â”‚
â”‚  â€¢ Obtener anÃ¡lisis enriquecido:                            â”‚
â”‚    - Contexto negocio                                       â”‚
â”‚    - Severidad                                              â”‚
â”‚    - Impacto                                                â”‚
â”‚    - RemediaciÃ³n                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Report Generator                               â”‚
â”‚         src/audit/report-generator.ts                       â”‚
â”‚  â€¢ Combinar hallazgos raw + anÃ¡lisis IA                     â”‚
â”‚  â€¢ Generar audit-report.md                                  â”‚
â”‚  â€¢ EstadÃ­sticas y resumen ejecutivo                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Flujo de EjecuciÃ³n Completo

```
Usuario ejecuta:
npm run audit:db
        â”‚
        â–¼
   [CLI Start]
        â”‚
        â”œâ”€â–º DockerManager.start()
        â”‚   â”œâ”€ Pull postgres:15 (si no existe)
        â”‚   â”œâ”€ Crear contenedor temporal
        â”‚   â””â”€ Esperar PostgreSQL ready (~10s)
        â”‚
        â”œâ”€â–º DockerManager.loadSchema('sql/full_schema.sql')
        â”‚   â”œâ”€ Leer archivo SQL (2000+ lÃ­neas)
        â”‚   â”œâ”€ Ejecutar en PostgreSQL
        â”‚   â””â”€ Validar carga exitosa (~15-20s)
        â”‚
        â”œâ”€â–º DbAuditor.runSecurityQueries()
        â”‚   â”œâ”€ Leer mini_suite_v2.sql
        â”‚   â”œâ”€ Ejecutar 14 queries
        â”‚   â””â”€ Recolectar hallazgos raw (~30s)
        â”‚
        â”œâ”€â–º DockerManager.stop()
        â”‚   â””â”€ Destruir contenedor (~3s)
        â”‚
        â”œâ”€â–º AiAnalyzer.analyze(rawFindings)
        â”‚   â”œâ”€ Construir prompt para Claude
        â”‚   â”œâ”€ Enviar a Anthropic API
        â”‚   â””â”€ Recibir anÃ¡lisis enriquecido (~20-40s)
        â”‚
        â””â”€â–º ReportGenerator.generate(rawFindings, aiAnalysis)
            â”œâ”€ Combinar datos
            â”œâ”€ Generar markdown
            â””â”€ Guardar audit-report.md (~2s)

Tiempo total: ~1.5 minutos
Output: audit-report.md
```

---

## 3. EspecificaciÃ³n TÃ©cnica de MÃ³dulos

### 3.1 Docker Manager (`src/audit/docker-manager.ts`)

#### Responsabilidad
Gestionar ciclo de vida completo de contenedor PostgreSQL efÃ­mero para auditorÃ­a.

#### Interfaz TypeScript

```typescript
import Docker from 'dockerode';

export interface DockerConfig {
  image: string;           // 'postgres:15'
  containerName: string;   // 'postgres-audit-temp'
  port: number;            // 5432
  password: string;        // 'postgres'
}

export interface ConnectionInfo {
  host: string;
  port: number;
  user: string;
  password: string;
  database: string;
}

export class DockerManager {
  private docker: Docker;
  private config: DockerConfig;
  private containerId?: string;

  constructor(config: DockerConfig);

  /**
   * Inicia contenedor PostgreSQL efÃ­mero.
   * Pull imagen si no existe.
   * Espera hasta que PostgreSQL estÃ© ready.
   *
   * @throws Error si falla inicio o timeout
   * @returns ConnectionInfo para conectar a BD
   */
  async start(): Promise<ConnectionInfo>;

  /**
   * Carga archivo SQL en PostgreSQL.
   * Lee archivo, ejecuta vÃ­a psql en contenedor.
   * Valida carga exitosa.
   *
   * @param schemaPath - Path absoluto a schema SQL
   * @throws Error si falla carga
   */
  async loadSchema(schemaPath: string): Promise<void>;

  /**
   * Detiene y elimina contenedor.
   * Libera recursos.
   * Idempotente: no falla si contenedor ya no existe.
   */
  async stop(): Promise<void>;

  /**
   * Ejecuta comando en contenedor.
   * Helper interno para psql commands.
   */
  private async execCommand(cmd: string[]): Promise<string>;

  /**
   * Espera hasta que PostgreSQL acepte conexiones.
   * Polling con timeout.
   */
  private async waitForPostgres(maxAttempts: number): Promise<void>;
}
```

#### Ejemplo de Uso

```typescript
const dockerManager = new DockerManager({
  image: 'postgres:15',
  containerName: 'postgres-audit-temp',
  port: 5432,
  password: 'postgres'
});

try {
  // Iniciar contenedor
  const connInfo = await dockerManager.start();
  console.log('âœ… PostgreSQL ready:', connInfo);

  // Cargar schema
  await dockerManager.loadSchema('/path/to/sql/full_schema.sql');
  console.log('âœ… Schema cargado');

  // ... ejecutar auditorÃ­a ...

} finally {
  // Siempre limpiar
  await dockerManager.stop();
  console.log('âœ… Contenedor destruido');
}
```

#### ImplementaciÃ³n Clave

```typescript
async start(): Promise<ConnectionInfo> {
  // 1. Pull imagen si no existe
  try {
    await this.docker.pull(this.config.image);
  } catch (err) {
    console.log('Imagen ya existe localmente');
  }

  // 2. Crear y iniciar contenedor
  const container = await this.docker.createContainer({
    Image: this.config.image,
    name: this.config.containerName,
    Env: [`POSTGRES_PASSWORD=${this.config.password}`],
    HostConfig: {
      PortBindings: {
        '5432/tcp': [{ HostPort: this.config.port.toString() }]
      },
      AutoRemove: false  // Removeremos manualmente
    }
  });

  await container.start();
  this.containerId = container.id;

  // 3. Esperar PostgreSQL ready
  await this.waitForPostgres(30);

  return {
    host: 'localhost',
    port: this.config.port,
    user: 'postgres',
    password: this.config.password,
    database: 'postgres'
  };
}
```

---

### 3.2 Security Queries (`src/audit/queries/mini_suite_v2.sql`)

#### DescripciÃ³n
Suite de 14 queries SQL que auditan seguridad del esquema PostgreSQL multi-tenant.

#### Contenido Completo

```sql
-- =======================================================================
-- MINI SUITE V2: AuditorÃ­a de Seguridad PostgreSQL Multi-Tenant
-- Base: vFinal-IA_1.md (Consolidado Multi-IA)
-- Fecha: 2025-11-04
-- =======================================================================

-- -----------------------------------------------------------------------
-- Query 1: Tablas sin RLS forzado
-- Riesgo: CRÃTICO - Permite acceso cross-tenant
-- -----------------------------------------------------------------------
SELECT
  n.nspname AS schema,
  c.relname AS table_name,
  CASE
    WHEN c.relrowsecurity = false THEN 'RLS no habilitado'
    WHEN c.relforcerowsecurity = false THEN 'RLS no forzado'
  END AS issue
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind = 'r'
  AND n.nspname = 'public'
  AND (c.relrowsecurity = false OR c.relforcerowsecurity = false);

-- -----------------------------------------------------------------------
-- Query 2: Policies triviales (USING true / WITH CHECK true)
-- Riesgo: ALTO - PolÃ­ticas no filtran por tenant_id
-- -----------------------------------------------------------------------
SELECT
  schemaname,
  tablename,
  policyname,
  cmd,
  qual AS using_clause,
  with_check
FROM pg_policies
WHERE qual ~* '^\s*true\s*$' OR with_check ~* '^\s*true\s*$';

-- -----------------------------------------------------------------------
-- Query 3: Funciones SECURITY DEFINER sin search_path fijo
-- Riesgo: ALTO - Vulnerable a trojan function attacks
-- -----------------------------------------------------------------------
SELECT
  n.nspname AS schema,
  p.proname AS function_name,
  p.prosecdef AS is_security_definer,
  p.proconfig AS configuration,
  CASE
    WHEN p.proconfig IS NULL THEN 'Sin search_path configurado'
    WHEN NOT (p.proconfig::text ~* 'search_path') THEN 'Sin search_path configurado'
    ELSE 'search_path configurado'
  END AS search_path_status
FROM pg_proc p
JOIN pg_namespace n ON n.oid = p.pronamespace
WHERE p.prosecdef = true
  AND n.nspname = 'public';

-- -----------------------------------------------------------------------
-- Query 4: Tablas con tenant_id sin FK a tenants
-- Riesgo: ALTO - Inconsistencia referencial cross-tenant
-- -----------------------------------------------------------------------
WITH tables_with_tenant_id AS (
  SELECT
    n.nspname AS schema,
    c.relname AS table_name
  FROM pg_class c
  JOIN pg_namespace n ON n.oid = c.relnamespace
  WHERE c.relkind = 'r'
    AND n.nspname = 'public'
    AND EXISTS (
      SELECT 1
      FROM information_schema.columns
      WHERE table_schema = n.nspname
        AND table_name = c.relname
        AND column_name = 'tenant_id'
    )
)
SELECT
  t.schema,
  t.table_name,
  'Sin FK a tenants' AS issue
FROM tables_with_tenant_id t
WHERE NOT EXISTS (
  SELECT 1
  FROM information_schema.table_constraints tc
  JOIN information_schema.constraint_column_usage ccu
    ON tc.constraint_name = ccu.constraint_name
  WHERE tc.table_schema = t.schema
    AND tc.table_name = t.table_name
    AND tc.constraint_type = 'FOREIGN KEY'
    AND ccu.column_name = 'tenant_id'
    AND ccu.table_name = 'tenants'
);

-- -----------------------------------------------------------------------
-- Query 5: idempotency_key sin UNIQUE
-- Riesgo: MEDIO - Permite transacciones duplicadas
-- -----------------------------------------------------------------------
SELECT
  c.table_schema AS schema,
  c.table_name,
  'idempotency_key sin constraint UNIQUE' AS issue
FROM information_schema.columns c
WHERE c.table_schema = 'public'
  AND c.column_name = 'idempotency_key'
  AND NOT EXISTS (
    SELECT 1
    FROM information_schema.table_constraints tc
    JOIN information_schema.constraint_column_usage ccu
      ON tc.constraint_name = ccu.constraint_name
    WHERE tc.table_schema = c.table_schema
      AND tc.table_name = c.table_name
      AND tc.constraint_type = 'UNIQUE'
      AND ccu.column_name = 'idempotency_key'
  );

-- -----------------------------------------------------------------------
-- Query 6: Policies de storage.objects
-- Riesgo: ALTO - Acceso no controlado a archivos cross-tenant
-- -----------------------------------------------------------------------
SELECT
  policyname,
  roles,
  cmd,
  qual AS using_clause,
  with_check
FROM pg_policies
WHERE schemaname = 'storage'
  AND tablename = 'objects';

-- -----------------------------------------------------------------------
-- Query 7: GRANTS amplios a anon/public
-- Riesgo: CRÃTICO - Usuarios no autenticados con permisos
-- -----------------------------------------------------------------------
SELECT
  table_schema AS schema,
  table_name,
  privilege_type,
  grantee
FROM information_schema.role_table_grants
WHERE table_schema IN ('public', 'storage')
  AND grantee IN ('public', 'anon')
ORDER BY table_schema, table_name, privilege_type;

-- -----------------------------------------------------------------------
-- Query 8: Extensiones con privilegios elevados
-- Riesgo: MEDIO - Extensiones peligrosas habilitadas
-- -----------------------------------------------------------------------
SELECT
  e.extname AS extension_name,
  r.rolname AS owner,
  e.extversion AS version,
  r.rolsuper AS owner_is_superuser,
  CASE
    WHEN e.extname IN ('pg_cron', 'pg_net', 'http', 'plv8', 'plpythonu')
    THEN 'ExtensiÃ³n potencialmente peligrosa'
    ELSE 'Revisar necesidad'
  END AS risk_level
FROM pg_extension e
JOIN pg_roles r ON r.oid = e.extowner
WHERE r.rolsuper = true
   OR e.extname IN ('pg_cron', 'pg_net', 'http', 'plv8', 'plpythonu');

-- -----------------------------------------------------------------------
-- Query 9: ValidaciÃ³n de pgaudit
-- Riesgo: BAJO - Sin logging de auditorÃ­a
-- -----------------------------------------------------------------------
SELECT
  name,
  setting,
  source
FROM pg_settings
WHERE name IN ('shared_preload_libraries', 'pgaudit.log', 'pgaudit.log_catalog');

-- -----------------------------------------------------------------------
-- Query 10: Funciones con DEFAULT inseguros
-- Riesgo: BAJO - Uso de current_user/current_role en defaults
-- -----------------------------------------------------------------------
SELECT
  n.nspname AS schema,
  p.proname AS function_name,
  pg_get_functiondef(p.oid) AS function_definition
FROM pg_proc p
JOIN pg_namespace n ON n.oid = p.pronamespace
WHERE pg_get_functiondef(p.oid) ~* 'default\s+current_(user|role)'
  AND n.nspname = 'public';

-- -----------------------------------------------------------------------
-- Query 11: Triggers con cÃ³digo dinÃ¡mico
-- Riesgo: MEDIO - SQL dinÃ¡mico sin validaciÃ³n
-- -----------------------------------------------------------------------
SELECT
  t.tgname AS trigger_name,
  c.relname AS table_name,
  pg_get_triggerdef(t.oid) AS trigger_definition
FROM pg_trigger t
JOIN pg_class c ON c.oid = t.tgrelid
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE pg_get_triggerdef(t.oid) ~* '(EXECUTE|eval|json_to_record)'
  AND n.nspname = 'public'
  AND NOT t.tgisinternal;  -- Excluir triggers internos

-- -----------------------------------------------------------------------
-- Query 12: Default privileges amplios
-- Riesgo: ALTO - Permisos por defecto inseguros
-- -----------------------------------------------------------------------
SELECT
  pg_get_userbyid(defaclrole) AS role,
  COALESCE(defaclnamespace::regnamespace::text, 'all schemas') AS schema,
  CASE defaclobjtype
    WHEN 'r' THEN 'tables'
    WHEN 'S' THEN 'sequences'
    WHEN 'f' THEN 'functions'
    WHEN 'T' THEN 'types'
    WHEN 'n' THEN 'schemas'
  END AS object_type,
  defaclacl AS default_acl
FROM pg_default_acl
WHERE defaclnamespace IS NULL
   OR defaclnamespace IN (
     SELECT oid
     FROM pg_namespace
     WHERE nspname IN ('public', 'storage')
   );

-- -----------------------------------------------------------------------
-- Query 13: Secuencias sin restricciones
-- Riesgo: BAJO - Secuencias sin control de acceso
-- -----------------------------------------------------------------------
SELECT
  sequence_schema AS schema,
  sequence_name,
  'Revisar permisos USAGE/SELECT' AS recommendation
FROM information_schema.sequences
WHERE sequence_schema = 'public';

-- -----------------------------------------------------------------------
-- Query 14: ValidaciÃ³n de versiÃ³n PostgreSQL
-- Riesgo: CRÃTICO si < 15.3 (CVE-2023-2454: RLS bypass)
-- -----------------------------------------------------------------------
SELECT
  version() AS postgresql_version,
  CASE
    WHEN version() ~* 'PostgreSQL (1[0-4]\.|15\.[0-2])'
    THEN 'VULNERABLE a CVE-2023-2454 (RLS bypass)'
    ELSE 'VersiÃ³n segura'
  END AS security_status;

-- =======================================================================
-- FIN MINI SUITE V2
-- =======================================================================
```

---

### 3.3 DB Auditor (`src/audit/db-auditor.ts`)

#### Responsabilidad
Ejecutar queries de seguridad y recolectar hallazgos estructurados.

#### Interfaz TypeScript

```typescript
import { Pool } from 'pg';
import { ConnectionInfo } from './docker-manager';

export interface SecurityFinding {
  queryId: number;
  queryName: string;
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  description: string;
  results: any[];  // Filas retornadas por query
  count: number;
}

export interface AuditResult {
  timestamp: Date;
  schemaFile: string;
  findings: SecurityFinding[];
  totalFindings: number;
  criticalCount: number;
  highCount: number;
  mediumCount: number;
  lowCount: number;
}

export class DbAuditor {
  private pool: Pool;
  private queriesPath: string;

  constructor(connInfo: ConnectionInfo, queriesPath: string);

  /**
   * Ejecuta suite completa de 14 queries.
   * Recolecta hallazgos de cada query.
   * Estructura resultados para anÃ¡lisis.
   *
   * @returns AuditResult con todos los hallazgos
   */
  async runSecurityQueries(): Promise<AuditResult>;

  /**
   * Ejecuta query individual y mapea resultados.
   */
  private async executeQuery(
    queryId: number,
    sql: string
  ): Promise<SecurityFinding>;

  /**
   * Mapea nÃºmero de query a metadatos.
   */
  private getQueryMetadata(queryId: number): {
    name: string;
    severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
    description: string;
  };

  /**
   * Parsea archivo mini_suite_v2.sql.
   * Separa queries individuales.
   */
  private parseQueriesFile(content: string): Array<{
    id: number;
    sql: string;
  }>;
}
```

#### Ejemplo de Uso

```typescript
const auditor = new DbAuditor(
  connectionInfo,
  'src/audit/queries/mini_suite_v2.sql'
);

const auditResult = await auditor.runSecurityQueries();

console.log(`Total hallazgos: ${auditResult.totalFindings}`);
console.log(`CrÃ­ticos: ${auditResult.criticalCount}`);
console.log(`Altos: ${auditResult.highCount}`);

// Iterar hallazgos
for (const finding of auditResult.findings) {
  if (finding.count > 0) {
    console.log(`[${finding.severity}] ${finding.queryName}`);
    console.log(`  Resultados: ${finding.count}`);
  }
}
```

#### Metadatos de Queries

```typescript
private getQueryMetadata(queryId: number) {
  const metadata = {
    1: {
      name: 'Tablas sin RLS forzado',
      severity: 'CRITICAL',
      description: 'Tablas sin Row Level Security habilitado o forzado'
    },
    2: {
      name: 'Policies triviales (USING true)',
      severity: 'HIGH',
      description: 'PolÃ­ticas RLS que no filtran por tenant_id'
    },
    3: {
      name: 'Funciones SECURITY DEFINER sin search_path',
      severity: 'HIGH',
      description: 'Funciones privilegiadas vulnerables a trojan attacks'
    },
    4: {
      name: 'Tablas tenant_id sin FK',
      severity: 'HIGH',
      description: 'Tablas multi-tenant sin integridad referencial'
    },
    5: {
      name: 'idempotency_key sin UNIQUE',
      severity: 'MEDIUM',
      description: 'Permite transacciones duplicadas'
    },
    6: {
      name: 'Policies storage.objects',
      severity: 'HIGH',
      description: 'Control de acceso a archivos en storage'
    },
    7: {
      name: 'GRANTS a anon/public',
      severity: 'CRITICAL',
      description: 'Permisos amplios a usuarios no autenticados'
    },
    8: {
      name: 'Extensiones privilegiadas',
      severity: 'MEDIUM',
      description: 'Extensiones con capacidades peligrosas'
    },
    9: {
      name: 'pgaudit ausente',
      severity: 'LOW',
      description: 'Sin logging de auditorÃ­a configurado'
    },
    10: {
      name: 'Funciones con DEFAULT current_user',
      severity: 'LOW',
      description: 'Uso potencialmente inseguro de current_user'
    },
    11: {
      name: 'Triggers con cÃ³digo dinÃ¡mico',
      severity: 'MEDIUM',
      description: 'Triggers con EXECUTE o SQL dinÃ¡mico'
    },
    12: {
      name: 'Default privileges amplios',
      severity: 'HIGH',
      description: 'Permisos por defecto inseguros en schemas'
    },
    13: {
      name: 'Secuencias sin restricciones',
      severity: 'LOW',
      description: 'Secuencias sin control de acceso explÃ­cito'
    },
    14: {
      name: 'VersiÃ³n PostgreSQL vulnerable',
      severity: 'CRITICAL',
      description: 'PostgreSQL < 15.3 vulnerable a CVE-2023-2454'
    }
  };

  return metadata[queryId];
}
```

---

### 3.4 AI Analyzer (`src/audit/ai-analyzer.ts`)

#### Responsabilidad
Enviar hallazgos raw a Claude API y obtener anÃ¡lisis enriquecido con contexto de negocio, priorizaciÃ³n y remediaciÃ³n.

#### Interfaz TypeScript

```typescript
import Anthropic from '@anthropic-ai/sdk';
import { AuditResult, SecurityFinding } from './db-auditor';

export interface AIAnalysis {
  summary: string;
  businessContext: string;
  prioritizedFindings: Array<{
    finding: SecurityFinding;
    businessImpact: string;
    realWorldScenario: string;
    remediation: {
      immediate: string[];
      shortTerm: string[];
      longTerm: string[];
    };
    estimatedEffort: string;
  }>;
  overallRisk: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  recommendations: string[];
}

export class AiAnalyzer {
  private client: Anthropic;
  private model: string;

  constructor(apiKey: string, model?: string);

  /**
   * Analiza hallazgos con Claude.
   * Genera contexto negocio, priorizaciÃ³n, remediaciÃ³n.
   *
   * @param auditResult - Hallazgos raw del auditor
   * @returns AIAnalysis enriquecido
   */
  async analyze(auditResult: AuditResult): Promise<AIAnalysis>;

  /**
   * Construye prompt para Claude con contexto especÃ­fico.
   */
  private buildPrompt(auditResult: AuditResult): string;

  /**
   * Parsea respuesta de Claude a estructura AIAnalysis.
   */
  private parseResponse(response: string): AIAnalysis;
}
```

#### Ejemplo de Uso

```typescript
const aiAnalyzer = new AiAnalyzer(
  process.env.ANTHROPIC_API_KEY!,
  'claude-3-5-sonnet-20241022'
);

const aiAnalysis = await aiAnalyzer.analyze(auditResult);

console.log('Resumen IA:', aiAnalysis.summary);
console.log('Riesgo general:', aiAnalysis.overallRisk);

for (const pf of aiAnalysis.prioritizedFindings) {
  console.log(`\n${pf.finding.queryName}`);
  console.log(`Impacto: ${pf.businessImpact}`);
  console.log(`RemediaciÃ³n inmediata: ${pf.remediation.immediate.join(', ')}`);
}
```

#### Prompt Template

```typescript
private buildPrompt(auditResult: AuditResult): string {
  return `Eres un experto en seguridad de bases de datos PostgreSQL multi-tenant.

Se realizÃ³ auditorÃ­a de seguridad en esquema PostgreSQL/Supabase con los siguientes hallazgos:

RESUMEN:
- Total hallazgos: ${auditResult.totalFindings}
- CrÃ­ticos: ${auditResult.criticalCount}
- Altos: ${auditResult.highCount}
- Medios: ${auditResult.mediumCount}
- Bajos: ${auditResult.lowCount}

HALLAZGOS DETALLADOS:
${auditResult.findings
  .filter(f => f.count > 0)
  .map(f => `
### ${f.queryName} [${f.severity}]
DescripciÃ³n: ${f.description}
Cantidad: ${f.count} instancias
Ejemplos:
${JSON.stringify(f.results.slice(0, 3), null, 2)}
`)
  .join('\n')}

CONTEXTO:
- AplicaciÃ³n: SaaS multi-tenant (B2B)
- Datos sensibles: PII de usuarios, transacciones financieras, datos de empresas
- Regulaciones: Preparando auditorÃ­a SOC 2
- Usuarios: ~1000 empresas, ~50000 usuarios finales

TAREA:
Analiza estos hallazgos y proporciona:

1. **Resumen ejecutivo** (3-4 oraciones)
2. **Contexto de negocio** (Â¿Por quÃ© esto importa para un SaaS?)
3. **AnÃ¡lisis detallado de cada hallazgo**:
   - Impacto real en el negocio
   - Escenario de ataque concreto
   - Pasos de remediaciÃ³n:
     * Inmediatos (hoy)
     * Corto plazo (esta semana)
     * Largo plazo (este mes)
   - Esfuerzo estimado (horas)
4. **Riesgo general** (CRITICAL/HIGH/MEDIUM/LOW)
5. **Recomendaciones priorizadas** (top 5)

FORMATO DE RESPUESTA:
Responde en formato JSON estructurado con la siguiente forma:

{
  "summary": "...",
  "businessContext": "...",
  "prioritizedFindings": [
    {
      "findingId": 1,
      "businessImpact": "...",
      "realWorldScenario": "...",
      "remediation": {
        "immediate": ["paso 1", "paso 2"],
        "shortTerm": ["paso 1"],
        "longTerm": ["paso 1"]
      },
      "estimatedEffort": "X horas"
    }
  ],
  "overallRisk": "CRITICAL|HIGH|MEDIUM|LOW",
  "recommendations": ["rec 1", "rec 2", "rec 3", "rec 4", "rec 5"]
}

Solo responde con JSON vÃ¡lido, sin markdown ni texto adicional.`;
}
```

---

### 3.5 Report Generator (`src/audit/report-generator.ts`)

#### Responsabilidad
Combinar hallazgos raw + anÃ¡lisis IA en reporte Markdown estructurado.

#### Interfaz TypeScript

```typescript
import { AuditResult } from './db-auditor';
import { AIAnalysis } from './ai-analyzer';

export interface ReportOptions {
  outputPath: string;
  includeRawData: boolean;
  includeRemediationCode: boolean;
}

export class ReportGenerator {
  /**
   * Genera reporte Markdown completo.
   * Combina hallazgos raw con anÃ¡lisis IA.
   * Incluye estadÃ­sticas, grÃ¡ficos ASCII, cÃ³digo remediaciÃ³n.
   *
   * @param auditResult - Hallazgos raw
   * @param aiAnalysis - AnÃ¡lisis IA
   * @param options - Opciones generaciÃ³n
   */
  async generate(
    auditResult: AuditResult,
    aiAnalysis: AIAnalysis,
    options: ReportOptions
  ): Promise<void>;

  /**
   * Genera secciÃ³n resumen ejecutivo.
   */
  private generateExecutiveSummary(
    auditResult: AuditResult,
    aiAnalysis: AIAnalysis
  ): string;

  /**
   * Genera grÃ¡fico ASCII distribuciÃ³n severidad.
   */
  private generateSeverityChart(auditResult: AuditResult): string;

  /**
   * Genera secciÃ³n detalle por hallazgo.
   */
  private generateFindingDetails(
    auditResult: AuditResult,
    aiAnalysis: AIAnalysis
  ): string;

  /**
   * Genera cÃ³digo SQL de remediaciÃ³n.
   */
  private generateRemediationSQL(finding: SecurityFinding): string;
}
```

#### Ejemplo de Uso

```typescript
const reportGenerator = new ReportGenerator();

await reportGenerator.generate(
  auditResult,
  aiAnalysis,
  {
    outputPath: 'audit-report.md',
    includeRawData: true,
    includeRemediationCode: true
  }
);

console.log('âœ… Reporte generado: audit-report.md');
```

---

### 3.6 CLI Entry Point (`src/audit/cli.ts`)

#### Responsabilidad
Orquestar flujo completo de auditorÃ­a desde lÃ­nea de comandos.

#### CÃ³digo Completo

```typescript
import * as path from 'path';
import * as dotenv from 'dotenv';
import { DockerManager } from './docker-manager';
import { DbAuditor } from './db-auditor';
import { AiAnalyzer } from './ai-analyzer';
import { ReportGenerator } from './report-generator';

dotenv.config();

async function main() {
  console.log('ğŸš€ Iniciando auditorÃ­a de seguridad de base de datos...\n');

  const startTime = Date.now();
  const dockerManager = new DockerManager({
    image: 'postgres:15',
    containerName: 'postgres-audit-temp',
    port: 5432,
    password: 'postgres'
  });

  try {
    // Paso 1: Iniciar contenedor PostgreSQL
    console.log('ğŸ“¦ Iniciando contenedor PostgreSQL...');
    const connInfo = await dockerManager.start();
    console.log('âœ… PostgreSQL listo\n');

    // Paso 2: Cargar schema
    console.log('ğŸ“‚ Cargando schema sql/full_schema.sql...');
    const schemaPath = path.resolve(__dirname, '../../sql/full_schema.sql');
    await dockerManager.loadSchema(schemaPath);
    console.log('âœ… Schema cargado\n');

    // Paso 3: Ejecutar queries de seguridad
    console.log('ğŸ” Ejecutando 14 queries de seguridad...');
    const queriesPath = path.resolve(__dirname, 'queries/mini_suite_v2.sql');
    const auditor = new DbAuditor(connInfo, queriesPath);
    const auditResult = await auditor.runSecurityQueries();
    console.log('âœ… Queries ejecutadas\n');

    // Paso 4: Destruir contenedor
    console.log('ğŸ—‘ï¸  Destruyendo contenedor...');
    await dockerManager.stop();
    console.log('âœ… Contenedor eliminado\n');

    // Paso 5: AnÃ¡lisis con IA
    console.log('ğŸ¤– Analizando hallazgos con Claude IA...');
    const apiKey = process.env.ANTHROPIC_API_KEY;
    if (!apiKey) {
      throw new Error('ANTHROPIC_API_KEY no configurado en .env');
    }
    const aiAnalyzer = new AiAnalyzer(apiKey);
    const aiAnalysis = await aiAnalyzer.analyze(auditResult);
    console.log('âœ… AnÃ¡lisis IA completado\n');

    // Paso 6: Generar reporte
    console.log('ğŸ“„ Generando reporte markdown...');
    const reportGenerator = new ReportGenerator();
    await reportGenerator.generate(auditResult, aiAnalysis, {
      outputPath: 'audit-report.md',
      includeRawData: true,
      includeRemediationCode: true
    });
    console.log('âœ… Reporte generado: audit-report.md\n');

    // Resumen final
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… AUDITORÃA COMPLETADA');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`â±ï¸  DuraciÃ³n: ${duration}s`);
    console.log(`ğŸ“Š Hallazgos:`);
    console.log(`   ğŸ”´ CrÃ­ticos: ${auditResult.criticalCount}`);
    console.log(`   ğŸŸ  Altos: ${auditResult.highCount}`);
    console.log(`   ğŸŸ¡ Medios: ${auditResult.mediumCount}`);
    console.log(`   ğŸŸ¢ Bajos: ${auditResult.lowCount}`);
    console.log(`ğŸ“„ Reporte: audit-report.md`);
    console.log(`ğŸ¯ Riesgo general: ${aiAnalysis.overallRisk}`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    process.exit(0);

  } catch (error) {
    console.error('âŒ Error en auditorÃ­a:', error);

    // Cleanup en caso de error
    try {
      await dockerManager.stop();
    } catch (cleanupError) {
      console.error('Error en cleanup:', cleanupError);
    }

    process.exit(1);
  }
}

// Ejecutar
main();
```

---

## 4. ConfiguraciÃ³n y Dependencias

### 4.1 Dependencias NPM

#### package.json - SecciÃ³n dependencies

```json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.27.0",
    "dockerode": "^4.0.2",
    "pg": "^8.11.3",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "@types/dockerode": "^3.3.23",
    "@types/node": "^20.10.0",
    "@types/pg": "^8.10.9",
    "ts-node": "^10.9.2",
    "typescript": "^5.3.3"
  }
}
```

#### package.json - Scripts

```json
{
  "scripts": {
    "audit:db": "ts-node src/audit/cli.ts"
  }
}
```

### 4.2 Variables de Entorno

#### `.env` (crear en raÃ­z del proyecto)

```bash
# Claude API Key
ANTHROPIC_API_KEY=sk-ant-api03-...

# ConfiguraciÃ³n Docker (opcional, usa defaults)
POSTGRES_IMAGE=postgres:15
POSTGRES_PORT=5432
POSTGRES_PASSWORD=postgres
```

#### `.env.example` (template para equipo)

```bash
# Claude API Key (obtener en https://console.anthropic.com/)
ANTHROPIC_API_KEY=

# ConfiguraciÃ³n Docker
POSTGRES_IMAGE=postgres:15
POSTGRES_PORT=5432
POSTGRES_PASSWORD=postgres
```

### 4.3 TypeScript Configuration

#### `tsconfig.json` (ajustes)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 4.4 Estructura de Directorios

```
agentes/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ audit/
â”‚       â”œâ”€â”€ cli.ts                    # Entry point
â”‚       â”œâ”€â”€ docker-manager.ts         # GestiÃ³n Docker
â”‚       â”œâ”€â”€ db-auditor.ts             # Ejecutor queries
â”‚       â”œâ”€â”€ ai-analyzer.ts            # AnÃ¡lisis IA
â”‚       â”œâ”€â”€ report-generator.ts       # Generador MD
â”‚       â””â”€â”€ queries/
â”‚           â””â”€â”€ mini_suite_v2.sql     # 14 queries
â”œâ”€â”€ sql/
â”‚   â””â”€â”€ full_schema.sql               # Schema a auditar
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ mvp-local-database-audit-design.md  # Este documento
â”œâ”€â”€ .env                              # Variables entorno (git-ignored)
â”œâ”€â”€ .env.example                      # Template
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ audit-report.md                   # Generado (git-ignored)
```

---

## 5. Ejemplo de Reporte Generado

### `audit-report.md` (ejemplo parcial)

```markdown
# ğŸ”’ AuditorÃ­a de Seguridad - Base de Datos PostgreSQL

**Fecha:** 2025-11-04 14:30:15
**Schema:** sql/full_schema.sql
**DuraciÃ³n:** 87 segundos
**Analizado por:** Claude (Anthropic)

---

## ğŸ“Š Resumen Ejecutivo

### EstadÃ­sticas

| MÃ©trica | Valor |
|---------|-------|
| Total hallazgos | 12 |
| ğŸ”´ CrÃ­ticos | 3 |
| ğŸŸ  Altos | 5 |
| ğŸŸ¡ Medios | 3 |
| ğŸŸ¢ Bajos | 1 |
| **Riesgo General** | **ğŸ”´ CRÃTICO** |

### DistribuciÃ³n de Severidad

```
CRÃTICO  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  25%  (3)
ALTO     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  42%  (5)
MEDIO    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  25%  (3)
BAJO     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  8%  (1)
```

### AnÃ¡lisis IA: Contexto de Negocio

Tu aplicaciÃ³n SaaS multi-tenant presenta **vulnerabilidades crÃ­ticas** que podrÃ­an
permitir acceso cross-tenant a datos sensibles. En un escenario SOC 2, estos hallazgos
serÃ­an **bloqueadores de certificaciÃ³n**. Los riesgos principales:

1. **Fuga de datos cross-tenant**: 3 tablas sin RLS forzado permiten que Tenant A
   vea datos de Tenant B
2. **EscalaciÃ³n de privilegios**: Roles anon/public con permisos amplios
3. **Vulnerabilidad PostgreSQL**: CVE-2023-2454 (RLS bypass) en versiÃ³n actual

**Impacto estimado si se explota:**
- PÃ©rdida de confianza de clientes (Ã©xodo masivo)
- Demandas legales por fuga PII
- Multas GDPR potenciales: hasta â‚¬20M
- Imposibilidad de certificar SOC 2

**AcciÃ³n requerida:** RemediaciÃ³n inmediata de hallazgos crÃ­ticos antes de producciÃ³n.

---

## ğŸ”´ Hallazgos CrÃ­ticos

### 1. Tablas sin RLS Forzado

**Severidad:** ğŸ”´ CRÃTICO
**Query ID:** 1
**Instancias:** 3

#### DescripciÃ³n TÃ©cnica

Las siguientes tablas no tienen Row Level Security (RLS) habilitado o forzado:

| Schema | Tabla | Issue |
|--------|-------|-------|
| public | logs | RLS no habilitado |
| public | audit_trail | RLS no habilitado |
| public | system_config | RLS no forzado |

#### Impacto de Negocio

**Escenario de ataque:**
1. Usuario malicioso de Tenant A se autentica normalmente
2. Modifica JWT token para incluir `org_id` de Tenant B
3. Sin RLS forzado, PostgreSQL **no valida** aislamiento
4. Resultado: Usuario A lee/escribe datos de Tenant B

**Datos expuestos:**
- `logs`: Actividad de todos los tenants (PII, acciones sensibles)
- `audit_trail`: Rastro completo de auditorÃ­a cross-tenant
- `system_config`: Configuraciones de otros clientes

**Consecuencias:**
- Fuga masiva de datos
- ViolaciÃ³n GDPR/CCPA
- PÃ©rdida de certificaciÃ³n SOC 2
- Demandas legales millonarias

#### RemediaciÃ³n

**Inmediato (hoy - 30min):**

```sql
-- Forzar RLS en todas las tablas afectadas
ALTER TABLE public.logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.logs FORCE ROW LEVEL SECURITY;

ALTER TABLE public.audit_trail ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.audit_trail FORCE ROW LEVEL SECURITY;

ALTER TABLE public.system_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.system_config FORCE ROW LEVEL SECURITY;
```

**Corto plazo (esta semana - 2h):**

```sql
-- Crear policies de aislamiento por tenant
CREATE POLICY tenant_isolation_logs
ON public.logs
FOR ALL
USING (tenant_id = (auth.jwt()->>'org_id')::uuid)
WITH CHECK (tenant_id = (auth.jwt()->>'org_id')::uuid);

-- Repetir para otras tablas...
```

**Largo plazo (este mes - 1 dÃ­a):**
- Automatizar aplicaciÃ³n de RLS en pipeline CI/CD
- Test de penetraciÃ³n cross-tenant
- Documentar polÃ­ticas RLS en docs/security.md

**Esfuerzo total:** 4 horas

---

### 2. GRANTS Amplios a anon/public

**Severidad:** ğŸ”´ CRÃTICO
**Query ID:** 7
**Instancias:** 23

#### DescripciÃ³n TÃ©cnica

Los roles `anon` y `public` tienen permisos en 23 tablas:

| Schema | Tabla | Privilegio | Grantee |
|--------|-------|------------|---------|
| public | users | SELECT | anon |
| public | profiles | SELECT, INSERT | anon |
| public | orders | SELECT | public |
| ... | ... | ... | ... |

#### Impacto de Negocio

**Escenario de ataque:**
1. Atacante accede sin autenticaciÃ³n (rol `anon`)
2. Ejecuta `SELECT * FROM users` â†’ obtiene toda la base de usuarios
3. Extrae emails, nombres, datos PII
4. Vende base de datos en dark web

**Datos expuestos:**
- Lista completa de usuarios (emails para phishing)
- Perfiles con datos demogrÃ¡ficos
- HistÃ³rico de Ã³rdenes (patrones de compra)

**Consecuencias:**
- Multa GDPR: hasta â‚¬20M (4% facturaciÃ³n anual)
- PÃ©rdida reputaciÃ³n: campaÃ±a phishing contra tus clientes
- Demandas colectivas

#### RemediaciÃ³n

**Inmediato (hoy - 15min):**

```sql
-- Revocar TODOS los permisos de anon/public
REVOKE ALL ON ALL TABLES IN SCHEMA public FROM anon, public;
REVOKE ALL ON ALL TABLES IN SCHEMA storage FROM anon, public;
REVOKE USAGE ON SCHEMA public FROM anon, public;
```

**Corto plazo (esta semana - 1h):**

```sql
-- Solo otorgar permisos explÃ­citos a authenticated
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT SELECT, INSERT, UPDATE ON public.profiles TO authenticated;
-- Continuar tabla por tabla segÃºn necesidad...
```

**Esfuerzo total:** 2 horas

---

## ğŸŸ  Hallazgos Altos

### 3. Funciones SECURITY DEFINER sin search_path

[... continÃºa con formato similar ...]

---

## ğŸ“‹ Plan de RemediaciÃ³n Priorizado

### Top 5 Recomendaciones (por ROI)

1. **[CRÃTICO] Revocar GRANTS anon/public** (15min, impacto mÃ¡ximo)
2. **[CRÃTICO] Forzar RLS en tablas** (30min, impacto mÃ¡ximo)
3. **[ALTO] Agregar FK tenant_id** (1h, previene inconsistencias)
4. **[CRÃTICO] Actualizar PostgreSQL â‰¥ 15.3** (2h en staging, evita CVE)
5. **[ALTO] Fijar search_path en SECURITY DEFINER** (1.5h, previene trojans)

**Esfuerzo total estimado:** 5-6 horas
**Riesgo residual despuÃ©s:** ğŸŸ¡ MEDIO

---

## ğŸ“– Anexos

### A. Datos Raw de AuditorÃ­a

<details>
<summary>Ver JSON completo de hallazgos</summary>

```json
{
  "timestamp": "2025-11-04T14:30:15Z",
  "findings": [
    {
      "queryId": 1,
      "queryName": "Tablas sin RLS forzado",
      "severity": "CRITICAL",
      "count": 3,
      "results": [...]
    }
  ]
}
```

</details>

### B. Referencias

- [PostgreSQL RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [CVE-2023-2454: RLS bypass](https://nvd.nist.gov/vuln/detail/CVE-2023-2454)
- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/row-level-security)
- [OWASP Multi-Tenancy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Multitenant_Architecture_Cheat_Sheet.html)

---

**Generado por:** Claude Code (MVP Local Database Audit System)
**VersiÃ³n sistema:** 1.0.0
```

---

## 6. Plan de ImplementaciÃ³n Paso a Paso

### Fase 1: Setup Inicial (30min)

#### 1.1 Instalar Dependencias

```bash
cd /Users/cmoreno/Code/personal/agentes

# Instalar dependencias
npm install dockerode @anthropic-ai/sdk pg dotenv
npm install -D @types/dockerode @types/pg ts-node typescript
```

#### 1.2 Configurar Variables de Entorno

```bash
# Crear .env
cat > .env <<EOF
ANTHROPIC_API_KEY=sk-ant-api03-YOUR_KEY_HERE
POSTGRES_IMAGE=postgres:15
POSTGRES_PORT=5432
POSTGRES_PASSWORD=postgres
EOF

# Crear .env.example
cat > .env.example <<EOF
ANTHROPIC_API_KEY=
POSTGRES_IMAGE=postgres:15
POSTGRES_PORT=5432
POSTGRES_PASSWORD=postgres
EOF

# Agregar a .gitignore
echo "audit-report.md" >> .gitignore
```

### Fase 2: Crear Estructura (15min)

```bash
# Crear directorios
mkdir -p src/audit/queries

# Archivos a crear:
# - src/audit/docker-manager.ts
# - src/audit/queries/mini_suite_v2.sql
# - src/audit/db-auditor.ts
# - src/audit/ai-analyzer.ts
# - src/audit/report-generator.ts
# - src/audit/cli.ts
```

### Fase 3: Implementar MÃ³dulos (4-5h)

#### 3.1 docker-manager.ts (1h)
- Implementar clase DockerManager
- MÃ©todos: start(), loadSchema(), stop()
- Manejo de errores y cleanup

#### 3.2 mini_suite_v2.sql (30min)
- Copiar 14 queries de vFinal-IA_1.md
- Agregar comentarios descriptivos
- Validar sintaxis SQL

#### 3.3 db-auditor.ts (1h)
- Implementar clase DbAuditor
- Parser de queries SQL
- EjecuciÃ³n y recolecciÃ³n resultados
- Mapeo de metadatos

#### 3.4 ai-analyzer.ts (1h)
- Implementar clase AiAnalyzer
- ConstrucciÃ³n prompt Claude
- Parsing respuesta JSON
- Manejo errores API

#### 3.5 report-generator.ts (1h)
- Implementar clase ReportGenerator
- Templates markdown
- GrÃ¡ficos ASCII
- CÃ³digo remediaciÃ³n SQL

#### 3.6 cli.ts (30min)
- OrquestaciÃ³n flujo completo
- Logging claro
- Manejo errores global

### Fase 4: ConfiguraciÃ³n NPM (5min)

```bash
# Agregar script a package.json
npm pkg set scripts.audit:db="ts-node src/audit/cli.ts"
```

### Fase 5: Testing (1h)

#### 5.1 Test Unitario (manual)

```bash
# Test 1: Docker Manager
ts-node -e "
import { DockerManager } from './src/audit/docker-manager';
const dm = new DockerManager({...});
await dm.start();
await dm.stop();
console.log('âœ… Docker OK');
"

# Test 2: DB Auditor
# (similar para cada mÃ³dulo)
```

#### 5.2 Test IntegraciÃ³n

```bash
# Ejecutar auditorÃ­a completa
npm run audit:db

# Validar:
# - Contenedor Docker creado y destruido
# - Schema cargado sin errores
# - 14 queries ejecutadas
# - Claude API responde
# - audit-report.md generado
```

#### 5.3 Test Re-ejecuciÃ³n

```bash
# Modificar sql/full_schema.sql
# Agregar tabla de prueba sin RLS
echo "CREATE TABLE test_table (id int);" >> sql/full_schema.sql

# Re-ejecutar
npm run audit:db

# Validar que detecta nueva tabla sin RLS
grep "test_table" audit-report.md
```

### Fase 6: DocumentaciÃ³n (30min)

#### 6.1 README Update

Agregar secciÃ³n en README.md:

```markdown
## AuditorÃ­a de Seguridad de Base de Datos

### Ejecutar auditorÃ­a local

\`\`\`bash
npm run audit:db
\`\`\`

Genera `audit-report.md` con anÃ¡lisis IA de seguridad del schema.

### Requisitos

- Docker instalado y running
- ANTHROPIC_API_KEY en .env
- Schema en sql/full_schema.sql

### Output

- audit-report.md: Reporte completo con remediaciÃ³n
```

---

## 7. MigraciÃ³n Futura a CI/CD (Fase 2)

### 7.1 ReutilizaciÃ³n de CÃ³digo

**CÃ³digo 100% reutilizable:**

```
src/audit/docker-manager.ts       âœ… IdÃ©ntico
src/audit/queries/mini_suite_v2.sql âœ… IdÃ©ntico
src/audit/db-auditor.ts            âœ… IdÃ©ntico
src/audit/ai-analyzer.ts           âœ… IdÃ©ntico
src/audit/report-generator.ts      âœ… IdÃ©ntico (salvo formato output)
```

**CÃ³digo nuevo para CI/CD:**

```
.github/workflows/database-audit.yml  âš ï¸ Nuevo
src/audit/github-commenter.ts         âš ï¸ Nuevo (comentar en PR)
src/audit/ci-cli.ts                   âš ï¸ Wrapper CI-specific
```

### 7.2 GitHub Actions Workflow

#### `.github/workflows/database-audit.yml`

```yaml
name: Database Security Audit

on:
  pull_request:
    paths:
      - 'sql/**'
      - 'migrations/**'

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database audit
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npm run audit:db:ci

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if critical findings
        run: |
          if grep -q "Riesgo General.*CRÃTICO" audit-report.md; then
            echo "âŒ Hallazgos crÃ­ticos detectados"
            exit 1
          fi
```

### 7.3 CI-Specific CLI

#### `src/audit/ci-cli.ts`

```typescript
import { main as localMain } from './cli';

async function ciMain() {
  // Misma lÃ³gica que cli.ts
  await localMain();

  // Adicional: determinar exit code
  const report = await fs.readFile('audit-report.md', 'utf8');
  if (report.includes('Riesgo General.*CRÃTICO')) {
    console.log('âŒ AuditorÃ­a fallÃ³: hallazgos crÃ­ticos');
    process.exit(1);
  }

  console.log('âœ… AuditorÃ­a pasÃ³');
  process.exit(0);
}

ciMain();
```

### 7.4 package.json Script

```json
{
  "scripts": {
    "audit:db": "ts-node src/audit/cli.ts",
    "audit:db:ci": "ts-node src/audit/ci-cli.ts"
  }
}
```

### 7.5 Esfuerzo MigraciÃ³n CI/CD

| Tarea | Esfuerzo | Notas |
|-------|----------|-------|
| Crear workflow YAML | 30min | Template estÃ¡ndar |
| Adaptar cli.ts para CI | 30min | Exit codes, logging |
| Configurar GitHub Secrets | 5min | ANTHROPIC_API_KEY |
| Testing en staging | 1h | Validar en PR real |
| DocumentaciÃ³n | 15min | README update |
| **TOTAL** | **2-3h** | **95% cÃ³digo reutilizado** |

---

## 8. Estimaciones y Recursos

### 8.1 Esfuerzo Total MVP

| Fase | DuraciÃ³n | Notas |
|------|----------|-------|
| Setup inicial | 30min | Deps + .env |
| Estructura | 15min | Crear dirs/archivos |
| ImplementaciÃ³n | 5h | 6 mÃ³dulos |
| Testing | 1h | Unit + integraciÃ³n |
| DocumentaciÃ³n | 30min | README update |
| **TOTAL** | **~7h** | **1 dÃ­a de trabajo** |

### 8.2 Recursos Necesarios

#### Docker
- Imagen: `postgres:15` (~150MB)
- Puerto: 5432 (local)
- RAM: ~100MB por ejecuciÃ³n

#### Claude API
- Modelo: `claude-3-5-sonnet-20241022`
- Tokens por auditorÃ­a: ~8000 (input) + 4000 (output)
- Costo: ~$0.12 USD por auditorÃ­a
- LÃ­mite: 50 requests/min (mÃ¡s que suficiente)

#### Disco
- Schema: ~200KB
- Reporte MD: ~50KB
- Logs: despreciable

### 8.3 Requisitos Sistema

- Node.js â‰¥ 18
- Docker Desktop o Docker Engine
- 500MB RAM disponible
- 500MB disco libre
- ConexiÃ³n internet (Claude API)

---

## 9. Riesgos y MitigaciÃ³n

### 9.1 Riesgos TÃ©cnicos

| Riesgo | Probabilidad | Impacto | MitigaciÃ³n |
|--------|--------------|---------|------------|
| Docker no instalado | Media | Alto | README claro, error descriptivo |
| Claude API key invÃ¡lido | Media | Alto | Validar en startup, .env.example |
| Schema SQL con errores | Alta | Medio | Try-catch, reportar lÃ­nea error |
| Timeout Claude API | Baja | Medio | Retry logic, timeout 60s |
| Schema muy grande (>10MB) | Baja | Bajo | Advertir en docs, lÃ­mite 20MB |

### 9.2 Riesgos de Negocio

| Riesgo | MitigaciÃ³n |
|--------|------------|
| Boss no valida MVP | Mostrar reporte ejemplo realista |
| Falsos positivos IA | Incluir datos raw para validaciÃ³n manual |
| Esfuerzo CI/CD subestimado | Documentar reutilizaciÃ³n 95% |

---

## 10. Siguientes Pasos

### 10.1 Post-MVP Inmediato

1. **Ejecutar primera auditorÃ­a** (5min)
   - Revisar reporte con boss
   - Validar utilidad anÃ¡lisis IA

2. **Iterar queries si necesario** (30min)
   - Agregar queries custom
   - Ajustar severidades

3. **Documentar hallazgos** (1h)
   - Crear plan remediaciÃ³n
   - Priorizar por ROI

### 10.2 Camino a CI/CD (Fase 2)

1. **ValidaciÃ³n en staging** (2h)
   - Probar con schemas histÃ³ricos
   - Validar consistencia resultados

2. **Implementar workflow GitHub Actions** (2-3h)
   - SegÃºn secciÃ³n 7.2
   - Testing en repo staging

3. **Activar en producciÃ³n** (30min)
   - Merge workflow
   - Monitorear primeros PRs

### 10.3 Mejoras Futuras (Opcionales)

- **Dashboard web**: Visualizar tendencias auditorÃ­as
- **Webhooks**: Alertas Slack/Teams hallazgos crÃ­ticos
- **ComparaciÃ³n histÃ³rica**: Detectar regresiones seguridad
- **Multi-schema**: Auditar mÃºltiples bases de datos
- **Custom rules**: YAML config para reglas especÃ­ficas empresa

---

## 11. ConclusiÃ³n

Este diseÃ±o tÃ©cnico proporciona:

âœ… **MVP funcional** en ~7h de implementaciÃ³n
âœ… **ReutilizaciÃ³n 95%+** para futura automatizaciÃ³n CI/CD
âœ… **AnÃ¡lisis IA enriquecido** con contexto negocio
âœ… **Sistema re-ejecutable** para iteraciÃ³n rÃ¡pida
âœ… **Base sÃ³lida** para certificaciÃ³n SOC 2

**PrÃ³xima acciÃ³n:** Aprobar diseÃ±o e iniciar implementaciÃ³n Fase 1.

---

**Documento preparado por:** Equipo de Desarrollo
**Revisado por:** (Pendiente aprobaciÃ³n)
**Ãšltima actualizaciÃ³n:** 2025-11-04
